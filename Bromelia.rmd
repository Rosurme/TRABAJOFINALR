---
title: "Bromelias"
author: "Rosario Ureña Mena. A76600"
format: 
  html:
    theme: cosmo
server: shiny
---
Universidad de Costa Rica

Maestría Académica en Gestión Integral del Recurso Hídrico

Curso PF 0953, Programación en R, 2022-II

Profesor: Manuel Vargas del Valle

# TRABAJO FINAL

Cargar librerías
```{r}
#| label: inicio
#| context: setup
#| message: false

library(shiny)
library(rsconnect)
library(tidyverse)
library(ggplot2)
library(readr)
library(plotly)
library(DT)
library(dplyr)
library(sf)
library(s2)
```
Cargar datos de presencia de bromelias en Costa Rica, según Infraestructura Mundial de Información en Biodiversidad (GBIF)
```{r}
#| label: lectura-datos
#| context: data

archivo_dwc <- "C:/Users/rosur/Documents/CURSO PROGRAMACION/TRABAJOFINALR/Bromelias.csv"

registros <-
  st_read(
    archivo_dwc,
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude", # columna de longitud decimal
      "Y_POSSIBLE_NAMES=decimalLatitude"   # columna de latitud decimal
    ),
    quiet = TRUE
  )

bromelias <- read_delim(file= "C:/Users/rosur/Documents/CURSO PROGRAMACION/TRABAJOFINALR/Bromelias.csv",
                       col_select = c(
      "species",
      "stateProvince",
      "locality",
      "eventDate",
      "decimalLongitude",
      "decimalLatitude"),
      locale = locale(encoding = "UTF-8"))

 
bromelias <- bromelias |>
   mutate(eventDate= as.Date(eventDate, format = "%d/%m/%Y"))
 
bromelias <- bromelias |>
  drop_na()
```


```{r}
#| panel: sidebar

lista_especies <- unique(bromelias$species)
lista_especies <- sort(lista_especies)
lista_especies <- c("Todas", lista_especies)

selectInput(
  inputId = "especie",
  label = "Especie",
  choices = lista_especies,
  selected = "Todas"
)
```

```{r}
#| panel: fill
dataTableOutput("tabla")

```

```{r}
#| label: servidor
#| context: server

filtrarRegistros <- reactive({
   registros_filtrados <- bromelias
  
  if (input$especie != "Todas") {
    registros_filtrados <-
      registros_filtrados |>
      filter(species == input$especie)
  }
  return(registros_filtrados)
})  

output$tabla <- renderDataTable({
  bromelias <- filtrarRegistros()
  
  bromelias |>
    st_drop_geometry() |>
    select(species, stateProvince, locality, eventDate, decimalLongitude,
      decimalLatitude) |>
    datatable(
      colnames = c("Especie", "Provincia", "Localidad", "Fecha", "Coordenada X", "Coordenada Y"),
      options = list(
        pageLength = 5,
        language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
      )
    )
})
```

```{r}
rsconnect::setAccountInfo(name='1b6bd6-rosurme', token='DDAB307F46C05C33C788C385374211F9', secret='sPLJaQO5rP04NbXvQCQExgz1Q1XvPNIvDb0H7VA9')
```
leaflet() |> #mapa en blanco
  addTiles()|>#fondo de Open Street MAp
  setView(lng = -84.19452, lat = 9.572735, zoom = 7) |>#centrar el mapa, el zoom va entre 1 y 20
  addPolygons(data = provincias, color = "black", 
              fillColor = "transparent", 
              weight = 1.0)|>
  addPolygons(data = SINAC, color = "Green", fillOpacity = 0.5) |>
  addCircleMarkers(data = registros,
                   radius = 4,
                   fillColor = "Red",
                   fillOpacity = 1.0,
                   popup = paste(paste0("<strong>Especie: </strong>",registros$species),
                                  registros$locality, 
                                 registros$eventDate,
                                 paste0("<a href='", registros$occurrenceID, "'>Más información</a>"),
                                 sep = "<br>"))
addLayersControl(
    baseGroups = c("OpenStreetMap"),
    overlayGroups = c("Provincias", "Áreas Silvestres Protegidas", "Bromelias"))
```


```{r}
rsconnect::setAccountInfo(name='1b6bd6-rosurme', token='DDAB307F46C05C33C788C385374211F9', secret='sPLJaQO5rP04NbXvQCQExgz1Q1XvPNIvDb0H7VA9')
```
